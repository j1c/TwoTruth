---
title: "On a `Two Truths` Phenomenon in Spectral Graph Clustering"
output: 
  bookdown::html_document2:
#  html_document:
    code_folding: show
    keep_md: true
#    css: ~/RFolder/pandoc.css
    fig_caption: yes
    fig_height: 4.5
    fig_width: 4.5
    number_sections: yes
    toc: yes
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, results='asis'}
suppressMessages(library(kableExtra))
#suppressMessages(library(captioner))
#tab_nums <- captioner(prefix="Table")
#fig_nums <- captioner()

suppressMessages(library(tidyverse))

library(knitr)
knitr::opts_chunk$set(echo=TRUE, eval=FALSE,warning=FALSE, message=FALSE)

#opts_knit$set(aliases=c(h='fig.height', w='fig.width', cap='fig.cap', scap='fig.scap'))                                                                               
#opts_knit$set(eval.after = c('fig.cap','fig.scap'))                                                                            
#knit_hooks$set(document = function(x) {                                                      #          gsub('(\\\\end\\{knitrout\\}[\n]+)', '\\1\\\\noindent ', x)                        #          })

```

-----

> Carey E. Priebe, Youngser Park, Joshua T. Vogelstein, John M. Conroy, Vince Lyzinskic, Minh Tang, Avanti Athreya, Joshua Cape, and Eric Bridgeford, "[On a 'Two Truths' Phenomenon in Spectral Graph Clustering](http://arxiv.org/abs/1808.07801)," _Proceedings of National Academy of Science_, submitted, 2018.


# Abstract

Clustering is concerned with coherently grouping observations without any explicit concept of true groupings. Spectral graph clustering -- clustering the vertices of a graph based on their spectral embedding -- is commonly approached via K-means (or, more generally, Gaussian mixture model) clustering composed with either Laplacian or Adjacency spectral embedding (LSE or ASE).
Recent theoretical results provide new understanding of the problem and solutions, and lead us to a 'Two Truths' LSE vs. ASE spectral graph clustering phenomenon
convincingly illustrated here via a diffusion MRI connectome data set:
 the different embedding methods yield different clustering results,
 with LSE capturing left hemisphere/right hemisphere affinity structure
 and ASE capturing gray matter/white matter core-periphery structure.
 
> **Keywords**: Spectral Embedding, Spectral Clustering, Graph, Network, Connectome

<figure>
<img src="vignettes/killerfig-cep-g1.jpg" width="700px" />
  <figcaption>Figure 1. Illustration of the Two Truths phenomenon.</figcaption>
</figure>


# Supplemental Information (SI)

## Data

Here we make available the connectome data used for our illustration:
114 graphs, and for each graph every vertex has a {Left,Right} label and a {Gray,White} label.

NB:
This is not meant to be a finding of neurscientific significance; 
rather, this is an illustration of our ‘Two Truths’ phenomenon. 
As such, we consider the largest connected component of binarized versions of the connectomes.
(The original diffusion MRI connectomes are symmetric, hollow, and weighted.)

The $m=114$ binary symmetric hollow graphs on $n \approx 40,000$ vertices
and associated vertex label attributes
can be downloaded as an R object:

```{r, echo=TRUE, eval=FALSE}
print(load(url("http://www.cis.jhu.edu/~parky/TT/Data/TT-glist114-binary.rda"))) 
# ~8GB, may take several minutes to load.
# This may fail with "Error: vector memory exhaused (limit reached?)" if there is not enough memory on your computer!
#[1] "glist"
length(glist)
#[1] 114

library(igraph)
summary(glist[[1]])
#IGRAPH b40d5fe UNW- 40813 2224492 -- sub-0025864_ses-1_dwi_DS72784
#+ attr: name (g/c), name (v/c), hemisphere (v/c), tissue (v/c), Y
#| (v/c), weight (e/n)

table(V(glist[[1]])$hemisphere)
# left right 
#20412 20401 

table(V(glist[[1]])$tissue)
# gray white 
#19353 21460 

table(V(glist[[1]])$Y)
#   LG    LW    RG    RW 
# 9664 10748  9689 10712 
```

```{r, echo=FALSE, eval=TRUE, fig.show='hold', fig.width=4.5, fig.height=4.5, fig.cap="Summary of data: number of vertices per graph by hemisphere/tissue type."}
library(TwoTruth)
data(twotruth)

twotruth %>% dplyr::select(c(2:8)) %>%
kable("html", escape=F, digits=2, align = "c", caption="Summary of data: number of vertices per graph by hemisphere/tissue type.") %>%
	  kable_styling("striped", full_width = F) %>%
	  column_spec(1, bold = T) %>%
	  collapse_rows(columns = c(1:7)) %>%  #add_header_above(c(" " = 3, "scan 1" = 5, "scan 2" = 5)) %>%
	  scroll_box(width = "600px", height = "500px")

new.dd <- twotruth %>% dplyr::select(c(2:8)) %>% dplyr::select(-3) %>% gather(`n.LG`:`n.RW`, key="class", value="count") %>% unique()
new.dd$graph <- factor(new.dd$graph, levels=paste(sort(as.integer(levels(new.dd$graph)))))
new.dd$count <- as.integer(new.dd$count)
new.dd <- new.dd %>% mutate(index=factor(paste(graph,scan)))
levels(new.dd$index) <- as.character(1:length(levels(new.dd$index)))
p1 <- ggplot(new.dd, aes(x=index, y=count, fill=class)) +
	geom_bar(stat="identity") + #facet_grid(~scan) + 
	theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") +
	theme(legend.title=element_blank()) +
	scale_x_discrete(breaks=as.character(seq(5,max(as.numeric(new.dd$index)),by=5)))
print(p1)
p2 <- new.dd %>% filter(count>3000) %>%
	ggplot(aes(x=class, y=count, fill=class)) + 
    geom_point(aes(col=class), alpha=0.5, position = position_jitterdodge(jitter.width=0.3)) +
	geom_boxplot(alpha=0.7, notch=TRUE, outlier.size = 0) +
	theme(legend.title=element_blank(), legend.position = "bottom")
print(p2)
```

Note that there is one bad graph in the data set: 
image processing failed for left hemisphere of subject 50 scan 2. 
(This anomaly is shown in the bar plot, not shown in the box plot.)
We have left this graph in, as is.


## Code

`R` code for the reproducing the experiemntal results presented in the manuscript is available in the `demo` folder at [github](https://github.com/youngser/TwoTruth).)

```{r echo=TRUE}
require(devtools)
devtools::install_github("youngser/TwoTruth")
# WARNING: This may take a while to install all the required packages!
# Also, depending on the enviroment, many packages need to be reinstalled/updated manually!
```

## Figures

```{r demo, eval=FALSE}
library(TwoTruth)
```

Figures from manuscript:

```{r fig6, echo=FALSE, eval=TRUE, fig.cap="Results of the ($\\widehat{d},\\widehat{K}$) model selection for spectral graph clustering for each of our 114 connectomes. For LSE we see $\\widehat{d} \\in \\{30,\\dots,60\\}$ and $\\widehat{K} \\in \\{2,\\dots,20\\}$; for ASE we see $\\widehat{d} \\in \\{2,\\dots,20\\}$ and $\\widehat{K} \\in \\{10,\\dots,50\\}$. The color-coding represents clustering performance in terms of ARI for each of LSE and ASE against each of the two truths \\{Left,Right\\} and \\{Gray,White\\}, and shows that LSE clustering identifies $\\{\\mbox{Left},\\mbox{Right}\\}$ better than $\\{\\mbox{Gray},\\mbox{White}\\}$ and ASE identifies $\\{\\mbox{Gray},\\mbox{White}\\}$ better than $\\{\\mbox{Left},\\mbox{Right}\\}$. Our \'Two Truths\' phenomenon is conclusively demonstrated: LSE finds $\\{\\mbox{Left},\\mbox{Right}\\}$ (affinity) while ASE finds $\\{\\mbox{Gray},\\mbox{White}\\}$ (core-periphery)."}
source("demo/doFig6.R")
```
```{r fig7, echo=FALSE, eval=TRUE, fig.cap="Spectral graph clustering assessment via ARI. For each of our 114 connectomes, we plot the difference in ARI for the $\\{\\mbox{Left},\\mbox{Right}\\}$ truth against the difference in ARI for the $\\{\\mbox{Gray},\\mbox{White}\\}$ truth for the clusterings produced by each of LSE and ASE: $x$ = ARI(LSE,LR) $-$ ARI(LSE,GW) vs. $y$ = ARI(ASE,LR) $-$ ARI(ASE,GW). A point in the $(+,-)$ quadrant indicates that for that connectome the LSE clustering identified $\\{\\mbox{Left},\\mbox{Right}\\}$ better than $\\{\\mbox{Gray},\\mbox{White}\\}$ and ASE identified $\\{\\mbox{Gray},\\mbox{White}\\}$ better than $\\{\\mbox{Left},\\mbox{Right}\\}$. Marginal histograms are provided. Our `Two Truths' phenomenon is conclusively demonstrated: LSE identifies $\\{\\mbox{Left},\\mbox{Right}\\}$ (affinity) while ASE identifies $\\{\\mbox{Gray},\\mbox{White}\\}$ (core-periphery)."}
source("demo/doFig7.R")
```
```{r figS1, echo=FALSE, eval=TRUE, fig.cap="$\\widehat{d}$ for our 114 connectomes -- scree plots and ZG1."}
source("demo/doFigS1.R")
```
```{r figS2, echo=FALSE, eval=TRUE, fig.cap="$\\widehat{K}$ for our 114 connectomes -- BIC curves."}
source("demo/doFigS2.R")
```

Generating figures from pre-calculated spectral clustering results:

* Figure S1 ($\widehat{d}$ via Zhu \& Ghodsi): `demo(doFigS1)`    
* Figure S2 ($\widehat{K}$ via MClust BIC):  `demo(doFigS2)`   
* Figure 6 ($\widehat{d}$, $\widehat{K}$, and ARI): `demo(doFig6)`  
* Figure 7 (ARI comparison): `demo(doFig7)` 

Generating spectral clustering results from the data:
(this takes tens of hours on my macbook):

Here is an example to run our spectral clustering on one graph:

```{r oneg, echo=TRUE, eval=FALSE}
library(TwoTruth)
load(url("http://www.cis.jhu.edu/~parky/TT/Data/g-s1s1.Rbin"))
summary(g)
#IGRAPH aa0dcd3 UNW- 40813 2224492 -- sub-0025864_ses-1_dwi_DS72784
#+ attr: name (g/c), name (v/c), hemisphere (v/c), tissue (v/c), Y (v/c), weight (e/n)

out <- sclust(g, weight="binary", embed="ASE", dmax=100, elb=NULL, Kmax=50, clustering="mclust") # this takes ~30 min in our linux server
out$mout$df
```

# Software and Hardware Information

```{r vn,echo=TRUE, eval=TRUE}
library(help='TwoTruth')
sessionInfo()
```

-----
Carey E Priebe & Youngser Park  
Department of Applied Mathematics and Statistics  
Johns Hopkins University  
 
*prepared by <youngser@jhu.edu> on `r date()`*
